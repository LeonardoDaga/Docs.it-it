---
title: Provider di configurazione di Azure Key Vault in ASP.NET Core
author: guardrex
description: Informazioni su come usare il Provider di configurazione dell'insieme di credenziali chiave Azure per configurare un'app usando coppie nome-valore in fase di esecuzione.
monikerRange: '>= aspnetcore-1.1'
ms.author: riande
ms.custom: mvc
ms.date: 10/24/2018
uid: security/key-vault-configuration
ms.openlocfilehash: c6dc8b9c462841351b3ada72deeae727da356a6c
ms.sourcegitcommit: 375e9a67f5e1f7b0faaa056b4b46294cc70f55b7
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 10/29/2018
ms.locfileid: "50207888"
---
# <a name="azure-key-vault-configuration-provider-in-aspnet-core"></a><span data-ttu-id="66ef0-103">Provider di configurazione di Azure Key Vault in ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="66ef0-103">Azure Key Vault configuration provider in ASP.NET Core</span></span>

<span data-ttu-id="66ef0-104">Dal [Luke Latham](https://github.com/guardrex) e [Andrew Stanton-Nurse](https://github.com/anurse)</span><span class="sxs-lookup"><span data-stu-id="66ef0-104">By [Luke Latham](https://github.com/guardrex) and [Andrew Stanton-Nurse](https://github.com/anurse)</span></span>

<span data-ttu-id="66ef0-105">Questo documento illustra come usare il [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) provider di configurazione per caricare i valori di configurazione di app da segreti di Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="66ef0-105">This document explains how to use the [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) configuration provider to load app configuration values from Azure Key Vault secrets.</span></span> <span data-ttu-id="66ef0-106">Azure Key Vault è un servizio basato sul cloud che consente di proteggere le chiavi crittografiche e segreti usati da App e servizi.</span><span class="sxs-lookup"><span data-stu-id="66ef0-106">Azure Key Vault is a cloud-based service that helps you safeguard cryptographic keys and secrets used by apps and services.</span></span> <span data-ttu-id="66ef0-107">Gli scenari comuni includono il controllo dell'accesso ai dati di configurazione sensibili e che soddisfano il requisito per FIPS 140-2 livello 2 convalidati i moduli di protezione Hardware (HSM) quando si archiviano i dati di configurazione.</span><span class="sxs-lookup"><span data-stu-id="66ef0-107">Common scenarios include controlling access to sensitive configuration data and meeting the requirement for FIPS 140-2 Level 2 validated Hardware Security Modules (HSM's) when storing configuration data.</span></span> <span data-ttu-id="66ef0-108">Questa funzionalità è disponibile per le app destinate a ASP.NET Core 1.1 o versione successiva.</span><span class="sxs-lookup"><span data-stu-id="66ef0-108">This feature is available for apps that target ASP.NET Core 1.1 or higher.</span></span>

<span data-ttu-id="66ef0-109">[Visualizzare o scaricare il codice di esempio](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples) ([procedura per il download](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="66ef0-109">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="package"></a><span data-ttu-id="66ef0-110">Pacchetto</span><span class="sxs-lookup"><span data-stu-id="66ef0-110">Package</span></span>

<span data-ttu-id="66ef0-111">Per usare il provider, aggiungere un riferimento per la [azurekeyvault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) pacchetto.</span><span class="sxs-lookup"><span data-stu-id="66ef0-111">To use the provider, add a reference to the [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) package.</span></span>

## <a name="app-configuration"></a><span data-ttu-id="66ef0-112">Configurazione delle App</span><span class="sxs-lookup"><span data-stu-id="66ef0-112">App configuration</span></span>

<span data-ttu-id="66ef0-113">È possibile esplorare il provider con il [app di esempio](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span><span class="sxs-lookup"><span data-stu-id="66ef0-113">You can explore the provider with the [sample apps](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span></span> <span data-ttu-id="66ef0-114">Dopo aver stabilito un insieme di credenziali chiave e creare i segreti nell'insieme di credenziali, caricare i valori del segreto nelle relative configurazioni in modo sicuro le app di esempio e visualizzati nelle pagine Web.</span><span class="sxs-lookup"><span data-stu-id="66ef0-114">Once you establish a key vault and create secrets in the vault, the sample apps securely load the secret values into their configurations and display them in webpages.</span></span>

<span data-ttu-id="66ef0-115">Il provider viene aggiunto alla configurazione dell'app con il `AddAzureKeyVault` estensione.</span><span class="sxs-lookup"><span data-stu-id="66ef0-115">The provider is added to the app's configuration with the `AddAzureKeyVault` extension.</span></span> <span data-ttu-id="66ef0-116">Nelle app di esempio, l'estensione utilizza tre valori di configurazione caricati dal *appSettings. JSON* file.</span><span class="sxs-lookup"><span data-stu-id="66ef0-116">In the sample apps, the extension uses three configuration values loaded from the *appsettings.json* file.</span></span>

| <span data-ttu-id="66ef0-117">Impostazione dell'App</span><span class="sxs-lookup"><span data-stu-id="66ef0-117">App Setting</span></span>    | <span data-ttu-id="66ef0-118">Descrizione</span><span class="sxs-lookup"><span data-stu-id="66ef0-118">Description</span></span>                    | <span data-ttu-id="66ef0-119">Esempio</span><span class="sxs-lookup"><span data-stu-id="66ef0-119">Example</span></span>                                      |
| -------------- | ------------------------------ | -------------------------------------------- |
| `Vault`        | <span data-ttu-id="66ef0-120">Nome dell'insieme di credenziali chiave Azure</span><span class="sxs-lookup"><span data-stu-id="66ef0-120">Azure Key Vault name</span></span>           | <span data-ttu-id="66ef0-121">contosovault</span><span class="sxs-lookup"><span data-stu-id="66ef0-121">contosovault</span></span>                                 |
| `ClientId`     | <span data-ttu-id="66ef0-122">Id App di Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="66ef0-122">Azure Active Directory App Id</span></span>  | <span data-ttu-id="66ef0-123">627e911e-43cc-61d4-992e-12db9c81b413</span><span class="sxs-lookup"><span data-stu-id="66ef0-123">627e911e-43cc-61d4-992e-12db9c81b413</span></span>         |
| `ClientSecret` | <span data-ttu-id="66ef0-124">Chiave dell'App Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="66ef0-124">Azure Active Directory App Key</span></span> | <span data-ttu-id="66ef0-125">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span><span class="sxs-lookup"><span data-stu-id="66ef0-125">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span></span> |

[!code-csharp[Program](key-vault-configuration/samples/basic-sample/2.x/Program.cs?name=snippet1)]

## <a name="create-key-vault-secrets-and-load-configuration-values-basic-sample"></a><span data-ttu-id="66ef0-126">Creare i segreti dell'insieme di credenziali chiave e caricare i valori di configurazione (esempio di basic)</span><span class="sxs-lookup"><span data-stu-id="66ef0-126">Create key vault secrets and load configuration values (basic-sample)</span></span>

1. <span data-ttu-id="66ef0-127">Creare un insieme di credenziali delle chiavi e configurare Azure Active Directory (Azure AD) per l'app seguendo le indicazioni fornite in [Introduzione a Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="66ef0-127">Create a key vault and set up Azure Active Directory (Azure AD) for the app following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
   * <span data-ttu-id="66ef0-128">Aggiungere i segreti all'insieme di credenziali delle chiavi utilizzando il [modulo di PowerShell insieme di credenziali delle chiavi di AzureRM](/powershell/module/azurerm.keyvault) disponibile dal [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), il [API REST di Azure Key Vault](/rest/api/keyvault/), o il [Portale di azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="66ef0-128">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="66ef0-129">I segreti vengono creati come *manuali* oppure *certificato* i segreti.</span><span class="sxs-lookup"><span data-stu-id="66ef0-129">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="66ef0-130">*Certificato* i segreti sono certificati da usare per le App e servizi, ma non sono supportati dal provider di configurazione.</span><span class="sxs-lookup"><span data-stu-id="66ef0-130">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="66ef0-131">È consigliabile usare la *manuale* opzione per creare i segreti di coppia nome-valore per l'uso con il provider di configurazione.</span><span class="sxs-lookup"><span data-stu-id="66ef0-131">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
     * <span data-ttu-id="66ef0-132">I segreti semplici vengono creati come coppie nome-valore.</span><span class="sxs-lookup"><span data-stu-id="66ef0-132">Simple secrets are created as name-value pairs.</span></span> <span data-ttu-id="66ef0-133">Azure Key Vault secret i nomi sono limitati da caratteri alfanumerici e trattini.</span><span class="sxs-lookup"><span data-stu-id="66ef0-133">Azure Key Vault secret names are limited to alphanumeric characters and dashes.</span></span>
     * <span data-ttu-id="66ef0-134">Usano i valori gerarchici (sezioni di configurazione) `--` (due trattini) come separatore dell'esempio.</span><span class="sxs-lookup"><span data-stu-id="66ef0-134">Hierarchical values (configuration sections) use `--` (two dashes) as a separator in the sample.</span></span> <span data-ttu-id="66ef0-135">I due punti, che vengono generalmente utilizzati per delimitare una sezione da una sottochiave [configurazione di ASP.NET Core](xref:fundamentals/configuration/index), non sono consentiti nei nomi di segreto.</span><span class="sxs-lookup"><span data-stu-id="66ef0-135">Colons, which are normally used to delimit a section from a subkey in [ASP.NET Core configuration](xref:fundamentals/configuration/index), aren't allowed in secret names.</span></span> <span data-ttu-id="66ef0-136">Pertanto, due trattini sono usati e scambiati per i due punti quando i segreti vengono caricati la configurazione dell'app.</span><span class="sxs-lookup"><span data-stu-id="66ef0-136">Therefore, two dashes are used and swapped for a colon when the secrets are loaded into the app's configuration.</span></span>
     * <span data-ttu-id="66ef0-137">Creare due *manuale* segreti con le seguenti coppie nome-valore.</span><span class="sxs-lookup"><span data-stu-id="66ef0-137">Create two *Manual* secrets with the following name-value pairs.</span></span> <span data-ttu-id="66ef0-138">La chiave privata prima un nome semplice e un valore e il segreto secondo crea un valore del segreto con una sezione e una sottochiave nel nome del segreto:</span><span class="sxs-lookup"><span data-stu-id="66ef0-138">The first secret is a simple name and value, and the second secret creates a secret value with a section and subkey in the secret name:</span></span>
       * <span data-ttu-id="66ef0-139">`SecretName`: `secret_value_1`</span><span class="sxs-lookup"><span data-stu-id="66ef0-139">`SecretName`: `secret_value_1`</span></span>
       * <span data-ttu-id="66ef0-140">`Section--SecretName`: `secret_value_2`</span><span class="sxs-lookup"><span data-stu-id="66ef0-140">`Section--SecretName`: `secret_value_2`</span></span>
   * <span data-ttu-id="66ef0-141">Registrare l'app di esempio con Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="66ef0-141">Register the sample app with Azure Active Directory.</span></span>
   * <span data-ttu-id="66ef0-142">Autorizzare l'app per l'insieme di credenziali delle chiavi di accesso.</span><span class="sxs-lookup"><span data-stu-id="66ef0-142">Authorize the app to access the key vault.</span></span> <span data-ttu-id="66ef0-143">Quando si usa la `Set-AzureRmKeyVaultAccessPolicy` cmdlet di PowerShell per autorizzare l'app per accedere a key vault, forniscono `List` e `Get` l'accesso ai segreti con `-PermissionsToSecrets list,get`.</span><span class="sxs-lookup"><span data-stu-id="66ef0-143">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToSecrets list,get`.</span></span>

2. <span data-ttu-id="66ef0-144">Aggiornare l'app *appSettings. JSON* file con valori di `Vault`, `ClientId`, e `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="66ef0-144">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="66ef0-145">Eseguire l'app di esempio che ottiene i valori di configurazione da `IConfigurationRoot` con lo stesso nome come nome del segreto.</span><span class="sxs-lookup"><span data-stu-id="66ef0-145">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the secret name.</span></span>
   * <span data-ttu-id="66ef0-146">I valori non gerarchico: il valore per `SecretName` viene ottenuto con `config["SecretName"]`.</span><span class="sxs-lookup"><span data-stu-id="66ef0-146">Non-hierarchical values: The value for `SecretName` is obtained with `config["SecretName"]`.</span></span>
   * <span data-ttu-id="66ef0-147">I valori gerarchici (sezioni): usare `:` notazione (due punti) o `GetSection` metodo di estensione.</span><span class="sxs-lookup"><span data-stu-id="66ef0-147">Hierarchical values (sections): Use `:` (colon) notation or the `GetSection` extension method.</span></span> <span data-ttu-id="66ef0-148">Per ottenere il valore di configurazione, usare uno di questi approcci:</span><span class="sxs-lookup"><span data-stu-id="66ef0-148">Use either of these approaches to obtain the configuration value:</span></span>
     * `config["Section:SecretName"]`
     * `config.GetSection("Section")["SecretName"]`

<span data-ttu-id="66ef0-149">Quando si esegue l'app, una pagina Web Mostra i valori del segreto caricati:</span><span class="sxs-lookup"><span data-stu-id="66ef0-149">When you run the app, a webpage shows the loaded secret values:</span></span>

![Finestra del browser con i valori dei segreti caricati tramite Azure Key Vault Configuration Provider](key-vault-configuration/_static/sample1.png)

## <a name="bind-an-array-to-a-class"></a><span data-ttu-id="66ef0-151">Associare una matrice a una classe</span><span class="sxs-lookup"><span data-stu-id="66ef0-151">Bind an array to a class</span></span>

<span data-ttu-id="66ef0-152">Il provider è in grado di leggere i valori di configurazione in una matrice per l'associazione a una matrice POCO.</span><span class="sxs-lookup"><span data-stu-id="66ef0-152">The provider is capable of reading configuration values into an array for binding to a POCO array.</span></span>

<span data-ttu-id="66ef0-153">Durante la lettura da un'origine di configurazione che consente di chiavi contenere i due punti (`:`) i separatori, un segmento della chiave numerico viene utilizzata per distinguere le chiavi che costituiscono una matrice (`:0:`, `:1:`,...</span><span class="sxs-lookup"><span data-stu-id="66ef0-153">When reading from a configuration source that allows keys to contain colon (`:`) separators, a numeric key segment is used to distinguish the keys that make up an array (`:0:`, `:1:`, …</span></span> <span data-ttu-id="66ef0-154">`:{n}:`).</span><span class="sxs-lookup"><span data-stu-id="66ef0-154">`:{n}:`).</span></span> <span data-ttu-id="66ef0-155">Per altre informazioni, vedere [configurazione: associare una matrice a una classe](xref:fundamentals/configuration/index#bind-an-array-to-a-class).</span><span class="sxs-lookup"><span data-stu-id="66ef0-155">For more information, see [Configuration: Bind an array to a class](xref:fundamentals/configuration/index#bind-an-array-to-a-class).</span></span>

<span data-ttu-id="66ef0-156">Le chiavi di Azure Key Vault non è possibile usare i due punti come separatore.</span><span class="sxs-lookup"><span data-stu-id="66ef0-156">Azure Key Vault keys can't use a colon as a separator.</span></span> <span data-ttu-id="66ef0-157">L'approccio descritto in questo argomento utilizza i trattini double (`--`) come separatore per i valori gerarchici (sezioni).</span><span class="sxs-lookup"><span data-stu-id="66ef0-157">The approach described in this topic uses double dashes (`--`) as a separator for hierarchical values (sections).</span></span> <span data-ttu-id="66ef0-158">Matrice chiavi vengono archiviate in Azure Key Vault con doppie trattini e segmenti di mercato principali numerici (`--0--`, `--1--`,...</span><span class="sxs-lookup"><span data-stu-id="66ef0-158">Array keys are stored in Azure Key Vault with double dashes and numeric key segments (`--0--`, `--1--`, …</span></span> <span data-ttu-id="66ef0-159">`--{n}--`).</span><span class="sxs-lookup"><span data-stu-id="66ef0-159">`--{n}--`).</span></span>

<span data-ttu-id="66ef0-160">Esaminare quanto segue [Serilog](https://serilog.net/) incluso in un file JSON di configurazione del provider di registrazione.</span><span class="sxs-lookup"><span data-stu-id="66ef0-160">Examine the following [Serilog](https://serilog.net/) logging provider configuration provided by a JSON file.</span></span> <span data-ttu-id="66ef0-161">Esistono due valori letterali definiti di oggetti di `WriteTo` matrice che riflettono Serilog due *sink*, che descrivono le destinazioni per l'output di registrazione:</span><span class="sxs-lookup"><span data-stu-id="66ef0-161">There are two object literals defined in the `WriteTo` array that reflect two Serilog *sinks*, which describe destinations for logging output:</span></span>

```json
"Serilog": {
  "WriteTo": [
    {
      "Name": "AzureTableStorage",
      "Args": {
        "storageTableName": "logs",
        "connectionString": "DefaultEnd...ountKey=Eby8...GMGw=="
      }
    },
    {
      "Name": "AzureDocumentDB",
      "Args": {
        "endpointUrl": "https://contoso.documents.azure.com:443",
        "authorizationKey": "Eby8...GMGw=="
      }
    }
  ]
}
```

<span data-ttu-id="66ef0-162">La configurazione illustrata nel file JSON precedente viene archiviata in Azure Key Vault con trattino doppio (`--`) segmenti notazione e numerici:</span><span class="sxs-lookup"><span data-stu-id="66ef0-162">The configuration shown in the preceding JSON file is stored in Azure Key Vault using double dash (`--`) notation and numeric segments:</span></span>

| <span data-ttu-id="66ef0-163">Chiave</span><span class="sxs-lookup"><span data-stu-id="66ef0-163">Key</span></span> | <span data-ttu-id="66ef0-164">Valore</span><span class="sxs-lookup"><span data-stu-id="66ef0-164">Value</span></span> |
| --- | ----- |
| `Serilog--WriteTo--0--Name` | `AzureTableStorage` |
| `Serilog--WriteTo--0--Args--storageTableName` | `logs` |
| `Serilog--WriteTo--0--Args--connectionString` | `DefaultEnd...ountKey=Eby8...GMGw==` |
| `Serilog--WriteTo--1--Name` | `AzureDocumentDB` |
| `Serilog--WriteTo--1--Args--endpointUrl` | `https://contoso.documents.azure.com:443` |
| `Serilog--WriteTo--1--Args--authorizationKey` | `Eby8...GMGw==` |

## <a name="create-prefixed-key-vault-secrets-and-load-configuration-values-key-name-prefix-sample"></a><span data-ttu-id="66ef0-165">Creare i segreti con prefisso insieme di credenziali delle chiavi e caricare i valori di configurazione (key-name-prefisso-esempio)</span><span class="sxs-lookup"><span data-stu-id="66ef0-165">Create prefixed key vault secrets and load configuration values (key-name-prefix-sample)</span></span>

<span data-ttu-id="66ef0-166">`AddAzureKeyVault` fornisce anche un overload che accetta un'implementazione di `IKeyVaultSecretManager`, che consente di controllare i segreti dell'insieme di credenziali chiave come vengono convertiti in chiavi di configurazione.</span><span class="sxs-lookup"><span data-stu-id="66ef0-166">`AddAzureKeyVault` also provides an overload that accepts an implementation of `IKeyVaultSecretManager`, which allows you to control how key vault secrets are converted into configuration keys.</span></span> <span data-ttu-id="66ef0-167">Ad esempio, è possibile implementare l'interfaccia per caricare i valori dei segreti basati su un valore di prefisso specificato all'avvio dell'app.</span><span class="sxs-lookup"><span data-stu-id="66ef0-167">For example, you can implement the interface to load secret values based on a prefix value you provide at app startup.</span></span> <span data-ttu-id="66ef0-168">Ciò consente, ad esempio, per caricare i segreti in base alla versione dell'app.</span><span class="sxs-lookup"><span data-stu-id="66ef0-168">This allows you, for example, to load secrets based on the version of the app.</span></span>

> [!WARNING]
> <span data-ttu-id="66ef0-169">Non usare prefissi su segreti dell'insieme di credenziali chiave inserisca i segreti per più app nel medesimo insieme di credenziali chiave o inserire i segreti dell'ambiente (ad esempio, *development* rispetto *produzione* segreti) nella stessa insieme di credenziali.</span><span class="sxs-lookup"><span data-stu-id="66ef0-169">Don't use prefixes on key vault secrets to place secrets for multiple apps into the same key vault or to place environmental secrets (for example, *development* versus *production* secrets) into the same vault.</span></span> <span data-ttu-id="66ef0-170">È consigliabile che diverse App e ambienti di sviluppo o di produzione usano insiemi di credenziali delle chiavi separati per isolare gli ambienti di app per il massimo livello di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="66ef0-170">We recommend that different apps and development/production environments use separate key vaults to isolate app environments for the highest level of security.</span></span>

<span data-ttu-id="66ef0-171">Si usa la seconda app di esempio, creare un segreto nell'insieme di credenziali chiave per `5000-AppSecret` (periodi non sono consentiti nei nomi di segreto dell'insieme di credenziali chiave) che rappresenta un segreto dell'app per la versione versione=5.0.0.0 dell'app.</span><span class="sxs-lookup"><span data-stu-id="66ef0-171">Using the second sample app, you create a secret in the key vault for `5000-AppSecret` (periods aren't allowed in key vault secret names) representing an app secret for version 5.0.0.0 of your app.</span></span> <span data-ttu-id="66ef0-172">Per un'altra versione, 5.1.0.0, si crea un segreto per `5100-AppSecret`.</span><span class="sxs-lookup"><span data-stu-id="66ef0-172">For another version, 5.1.0.0, you create a secret for `5100-AppSecret`.</span></span> <span data-ttu-id="66ef0-173">Ogni versione dell'app carica il proprio valore del segreto in sua configurazione come `AppSecret`, stripping disattivata la versione durante il caricamento del segreto.</span><span class="sxs-lookup"><span data-stu-id="66ef0-173">Each app version loads its own secret value into its configuration as `AppSecret`, stripping off the version as it loads the secret.</span></span> <span data-ttu-id="66ef0-174">L'implementazione dell'esempio è illustrato di seguito:</span><span class="sxs-lookup"><span data-stu-id="66ef0-174">The sample's implementation is shown below:</span></span>

[!code-csharp[Configuration builder](key-vault-configuration/samples/key-name-prefix-sample/2.x/Program.cs?name=snippet1&highlight=18)]

[!code-csharp[PrefixKeyVaultSecretManager](key-vault-configuration/samples/key-name-prefix-sample/2.x/Startup.cs?name=snippet1)]

<span data-ttu-id="66ef0-175">Il `Load` metodo viene chiamato da un algoritmo di provider che esegue l'iterazione attraverso i segreti dell'insieme di credenziali per individuare quelli che dispongono del prefisso della versione.</span><span class="sxs-lookup"><span data-stu-id="66ef0-175">The `Load` method is called by a provider algorithm that iterates through the vault secrets to find the ones that have the version prefix.</span></span> <span data-ttu-id="66ef0-176">Quando viene trovato un prefisso di versione con `Load`, l'algoritmo utilizza il `GetKey` per restituire il nome della configurazione del nome del segreto.</span><span class="sxs-lookup"><span data-stu-id="66ef0-176">When a version prefix is found with `Load`, the algorithm uses the `GetKey` method to return the configuration name of the secret name.</span></span> <span data-ttu-id="66ef0-177">Questo rimuove il prefisso di versione dal nome del segreto e restituisce il resto del nome del segreto per il caricamento nella configurazione dell'app per le coppie nome-valore.</span><span class="sxs-lookup"><span data-stu-id="66ef0-177">It strips off the version prefix from the secret's name and returns the rest of the secret name for loading into the app's configuration name-value pairs.</span></span>

<span data-ttu-id="66ef0-178">Quando si implementa questo approccio:</span><span class="sxs-lookup"><span data-stu-id="66ef0-178">When you implement this approach:</span></span>

1. <span data-ttu-id="66ef0-179">Vengono caricati i segreti dell'insieme di credenziali chiave.</span><span class="sxs-lookup"><span data-stu-id="66ef0-179">The key vault secrets are loaded.</span></span>
2. <span data-ttu-id="66ef0-180">Il segreto di stringa per `5000-AppSecret` esiste una corrispondenza.</span><span class="sxs-lookup"><span data-stu-id="66ef0-180">The string secret for `5000-AppSecret` is matched.</span></span>
3. <span data-ttu-id="66ef0-181">La versione `5000` (con il trattino), viene rimosso dal nome della chiave lasciando `AppSecret` per caricare la configurazione dell'app con il valore del segreto.</span><span class="sxs-lookup"><span data-stu-id="66ef0-181">The version, `5000` (with the dash), is stripped off of the key name leaving `AppSecret` to load with the secret value into the app's configuration.</span></span>

> [!NOTE]
> <span data-ttu-id="66ef0-182">È anche possibile fornire una propria `KeyVaultClient` implementazione di `AddAzureKeyVault`.</span><span class="sxs-lookup"><span data-stu-id="66ef0-182">You can also provide your own `KeyVaultClient` implementation to `AddAzureKeyVault`.</span></span> <span data-ttu-id="66ef0-183">Fornisce un client personalizzato consente di condividere una singola istanza del client tra il provider di configurazione e altre parti dell'app.</span><span class="sxs-lookup"><span data-stu-id="66ef0-183">Supplying a custom client allows you to share a single instance of the client between the configuration provider and other parts of your app.</span></span>

1. <span data-ttu-id="66ef0-184">Creare un insieme di credenziali delle chiavi e configurare Azure Active Directory (Azure AD) per l'app seguendo le indicazioni fornite in [Introduzione a Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="66ef0-184">Create a key vault and set up Azure Active Directory (Azure AD) for the app following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
   * <span data-ttu-id="66ef0-185">Aggiungere i segreti all'insieme di credenziali delle chiavi utilizzando il [modulo di PowerShell insieme di credenziali delle chiavi di AzureRM](/powershell/module/azurerm.keyvault) disponibile dal [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), il [API REST di Azure Key Vault](/rest/api/keyvault/), o il [Portale di azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="66ef0-185">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="66ef0-186">I segreti vengono creati come *manuali* oppure *certificato* i segreti.</span><span class="sxs-lookup"><span data-stu-id="66ef0-186">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="66ef0-187">*Certificato* i segreti sono certificati da usare per le App e servizi, ma non sono supportati dal provider di configurazione.</span><span class="sxs-lookup"><span data-stu-id="66ef0-187">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="66ef0-188">È consigliabile usare la *manuale* opzione per creare i segreti di coppia nome-valore per l'uso con il provider di configurazione.</span><span class="sxs-lookup"><span data-stu-id="66ef0-188">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
     * <span data-ttu-id="66ef0-189">Usano i valori gerarchici (sezioni di configurazione) `--` (due trattini) come separatore.</span><span class="sxs-lookup"><span data-stu-id="66ef0-189">Hierarchical values (configuration sections) use `--` (two dashes) as a separator.</span></span>
     * <span data-ttu-id="66ef0-190">Creare due *manuale* segreti con le seguenti coppie nome-valore:</span><span class="sxs-lookup"><span data-stu-id="66ef0-190">Create two *Manual* secrets with the following name-value pairs:</span></span>
       * <span data-ttu-id="66ef0-191">`5000-AppSecret`: `5.0.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="66ef0-191">`5000-AppSecret`: `5.0.0.0_secret_value`</span></span>
       * <span data-ttu-id="66ef0-192">`5100-AppSecret`: `5.1.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="66ef0-192">`5100-AppSecret`: `5.1.0.0_secret_value`</span></span>
   * <span data-ttu-id="66ef0-193">Registrare l'app di esempio con Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="66ef0-193">Register the sample app with Azure Active Directory.</span></span>
   * <span data-ttu-id="66ef0-194">Autorizzare l'app per l'insieme di credenziali delle chiavi di accesso.</span><span class="sxs-lookup"><span data-stu-id="66ef0-194">Authorize the app to access the key vault.</span></span> <span data-ttu-id="66ef0-195">Quando si usa la `Set-AzureRmKeyVaultAccessPolicy` cmdlet di PowerShell per autorizzare l'app per accedere a key vault, forniscono `List` e `Get` l'accesso ai segreti con `-PermissionsToSecrets list,get`.</span><span class="sxs-lookup"><span data-stu-id="66ef0-195">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToSecrets list,get`.</span></span>

2. <span data-ttu-id="66ef0-196">Aggiornare l'app *appSettings. JSON* file con valori di `Vault`, `ClientId`, e `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="66ef0-196">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="66ef0-197">Eseguire l'app di esempio che ottiene i valori di configurazione da `IConfigurationRoot` con lo stesso nome come nome del segreto con prefisso.</span><span class="sxs-lookup"><span data-stu-id="66ef0-197">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the prefixed secret name.</span></span> <span data-ttu-id="66ef0-198">In questo esempio, il prefisso è la versione dell'app, che è fornito per il `PrefixKeyVaultSecretManager` quando è stato aggiunto il provider di configurazione di Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="66ef0-198">In this sample, the prefix is the app's version, which you provided to the `PrefixKeyVaultSecretManager` when you added the Azure Key Vault configuration provider.</span></span> <span data-ttu-id="66ef0-199">Il valore per `AppSecret` viene ottenuto con `config["AppSecret"]`.</span><span class="sxs-lookup"><span data-stu-id="66ef0-199">The value for `AppSecret` is obtained with `config["AppSecret"]`.</span></span> <span data-ttu-id="66ef0-200">La pagina Web generata dall'app Mostra il valore caricato:</span><span class="sxs-lookup"><span data-stu-id="66ef0-200">The webpage generated by the app shows the loaded value:</span></span>

   ![Finestra del browser con un valore del segreto caricato tramite Azure Key Vault Configuration Provider quando la versione dell'app è versione=5.0.0.0](key-vault-configuration/_static/sample2-1.png)

4. <span data-ttu-id="66ef0-202">Modificare la versione di assembly dell'app nel file di progetto dal `5.0.0.0` a `5.1.0.0` ed eseguire nuovamente l'app.</span><span class="sxs-lookup"><span data-stu-id="66ef0-202">Change the version of the app assembly in the project file from `5.0.0.0` to `5.1.0.0` and run the app again.</span></span> <span data-ttu-id="66ef0-203">Questa volta, viene restituito il valore del segreto `5.1.0.0_secret_value`.</span><span class="sxs-lookup"><span data-stu-id="66ef0-203">This time, the secret value returned is `5.1.0.0_secret_value`.</span></span> <span data-ttu-id="66ef0-204">La pagina Web generata dall'app Mostra il valore caricato:</span><span class="sxs-lookup"><span data-stu-id="66ef0-204">The webpage generated by the app shows the loaded value:</span></span>

   ![Finestra del browser con un valore del segreto caricato tramite Azure Key Vault Configuration Provider quando la versione dell'app è 5.1.0.0](key-vault-configuration/_static/sample2-2.png)

## <a name="control-access-to-the-clientsecret"></a><span data-ttu-id="66ef0-206">Controllare l'accesso per il segreto client</span><span class="sxs-lookup"><span data-stu-id="66ef0-206">Control access to the ClientSecret</span></span>

<span data-ttu-id="66ef0-207">Usare la [strumento Secret Manager](xref:security/app-secrets) mantenere il `ClientSecret` di fuori dell'albero di origine del progetto.</span><span class="sxs-lookup"><span data-stu-id="66ef0-207">Use the [Secret Manager tool](xref:security/app-secrets) to maintain the `ClientSecret` outside of your project source tree.</span></span> <span data-ttu-id="66ef0-208">Con Secret Manager, associare i segreti dell'app a un progetto specifico e condividerli tra più progetti.</span><span class="sxs-lookup"><span data-stu-id="66ef0-208">With Secret Manager, you associate app secrets with a specific project and share them across multiple projects.</span></span>

<span data-ttu-id="66ef0-209">Quando si sviluppa un'app .NET Framework in un ambiente che supporta i certificati, è possibile eseguire l'autenticazione ad Azure Key Vault con un certificato X.509.</span><span class="sxs-lookup"><span data-stu-id="66ef0-209">When developing a .NET Framework app in an environment that supports certificates, you can authenticate to Azure Key Vault with an X.509 certificate.</span></span> <span data-ttu-id="66ef0-210">Chiave privata del certificato X.509 viene gestita dal sistema operativo.</span><span class="sxs-lookup"><span data-stu-id="66ef0-210">The X.509 certificate's private key is managed by the OS.</span></span> <span data-ttu-id="66ef0-211">Per altre informazioni, vedere [eseguire l'autenticazione con un certificato anziché un segreto Client](/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span><span class="sxs-lookup"><span data-stu-id="66ef0-211">For more information, see [Authenticate with a Certificate instead of a Client Secret](/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span></span> <span data-ttu-id="66ef0-212">Usare la `AddAzureKeyVault` overload che accetta un `X509Certificate2` (`_env` nell'esempio seguente:</span><span class="sxs-lookup"><span data-stu-id="66ef0-212">Use the `AddAzureKeyVault` overload that accepts an `X509Certificate2` (`_env` in the following example :</span></span>

```csharp
var builtConfig = config.Build();

var store = new X509Store(StoreLocation.CurrentUser);
store.Open(OpenFlags.ReadOnly);
var cert = store.Certificates
    .Find(X509FindType.FindByThumbprint, 
        config["CertificateThumbprint"], false);

config.AddAzureKeyVault(
    builtConfig["Vault"],
    builtConfig["ClientId"],
    cert.OfType<X509Certificate2>().Single(),
    new EnvironmentSecretManager(context.HostingEnvironment.ApplicationName));

store.Close();
```

## <a name="reload-secrets"></a><span data-ttu-id="66ef0-213">Ricaricare i segreti</span><span class="sxs-lookup"><span data-stu-id="66ef0-213">Reload secrets</span></span>

<span data-ttu-id="66ef0-214">I segreti vengono memorizzati nella cache fino a `IConfigurationRoot.Reload()` viene chiamato.</span><span class="sxs-lookup"><span data-stu-id="66ef0-214">Secrets are cached until `IConfigurationRoot.Reload()` is called.</span></span> <span data-ttu-id="66ef0-215">Scaduto, disabilitato, e aggiornati i segreti nell'insieme di credenziali chiave non vengono rispettati dall'app fino al `Reload` viene eseguita.</span><span class="sxs-lookup"><span data-stu-id="66ef0-215">Expired, disabled, and updated secrets in the key vault are not respected by the app until `Reload` is executed.</span></span>

```csharp
Configuration.Reload();
```

## <a name="disabled-and-expired-secrets"></a><span data-ttu-id="66ef0-216">Segreti scaduti e disabilitati</span><span class="sxs-lookup"><span data-stu-id="66ef0-216">Disabled and expired secrets</span></span>

<span data-ttu-id="66ef0-217">I segreti scaduti e disabilitati generano un `KeyVaultClientException`.</span><span class="sxs-lookup"><span data-stu-id="66ef0-217">Disabled and expired secrets throw a `KeyVaultClientException`.</span></span> <span data-ttu-id="66ef0-218">Per evitare che l'app generi, sostituire l'app o aggiornare il segreto disabilitato o scaduto.</span><span class="sxs-lookup"><span data-stu-id="66ef0-218">To prevent your app from throwing, replace your app or update the disabled/expired secret.</span></span>

## <a name="troubleshoot"></a><span data-ttu-id="66ef0-219">Risolvere i problemi</span><span class="sxs-lookup"><span data-stu-id="66ef0-219">Troubleshoot</span></span>

<span data-ttu-id="66ef0-220">L'app non riesce a caricare la configurazione utilizzando il provider, viene scritto un messaggio di errore per il [registrazione di ASP.NET Core infrastructure](xref:fundamentals/logging/index).</span><span class="sxs-lookup"><span data-stu-id="66ef0-220">When the app fails to load configuration using the provider, an error message is written to the [ASP.NET Core Logging infrastructure](xref:fundamentals/logging/index).</span></span> <span data-ttu-id="66ef0-221">Configurazione del caricamento impedire che le condizioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="66ef0-221">The following conditions will prevent configuration from loading:</span></span>

* <span data-ttu-id="66ef0-222">L'app non è configurato correttamente in Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="66ef0-222">The app isn't configured correctly in Azure Active Directory.</span></span>
* <span data-ttu-id="66ef0-223">L'insieme di credenziali delle chiavi non esiste in Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="66ef0-223">The key vault doesn't exist in Azure Key Vault.</span></span>
* <span data-ttu-id="66ef0-224">L'app non è autorizzato ad accedere l'insieme di credenziali delle chiavi.</span><span class="sxs-lookup"><span data-stu-id="66ef0-224">The app isn't authorized to access the key vault.</span></span>
* <span data-ttu-id="66ef0-225">I criteri di accesso non includano `Get` e `List` autorizzazioni.</span><span class="sxs-lookup"><span data-stu-id="66ef0-225">The access policy doesn't include `Get` and `List` permissions.</span></span>
* <span data-ttu-id="66ef0-226">Nell'insieme di credenziali chiave, i dati di configurazione (coppia nome-valore) in modo non corretto denominati, mancante, disabilitato o scaduto.</span><span class="sxs-lookup"><span data-stu-id="66ef0-226">In the key vault, the configuration data (name-value pair) is incorrectly named, missing, disabled, or expired.</span></span>
* <span data-ttu-id="66ef0-227">L'app con il nome dell'insieme di credenziali chiave errata (`Vault`), Id di App di Azure AD (`ClientId`), o la chiave di Azure AD (`ClientSecret`).</span><span class="sxs-lookup"><span data-stu-id="66ef0-227">The app has the wrong key vault name (`Vault`), Azure AD App Id (`ClientId`), or Azure AD Key (`ClientSecret`).</span></span>
* <span data-ttu-id="66ef0-228">La chiave di Azure AD (`ClientSecret`) è scaduto.</span><span class="sxs-lookup"><span data-stu-id="66ef0-228">The Azure AD Key (`ClientSecret`) is expired.</span></span>
* <span data-ttu-id="66ef0-229">Non è corretta nell'app per il valore che si sta provando a caricare la chiave di configurazione (nome).</span><span class="sxs-lookup"><span data-stu-id="66ef0-229">The configuration key (name) is incorrect in the app for the value you're trying to load.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="66ef0-230">Risorse aggiuntive</span><span class="sxs-lookup"><span data-stu-id="66ef0-230">Additional resources</span></span>

* <xref:fundamentals/configuration/index>
* [<span data-ttu-id="66ef0-231">Microsoft Azure: Insieme di credenziali delle chiavi</span><span class="sxs-lookup"><span data-stu-id="66ef0-231">Microsoft Azure: Key Vault</span></span>](https://azure.microsoft.com/services/key-vault/)
* [<span data-ttu-id="66ef0-232">Microsoft Azure: Documentazione su Key Vault</span><span class="sxs-lookup"><span data-stu-id="66ef0-232">Microsoft Azure: Key Vault Documentation</span></span>](/azure/key-vault/)
* [<span data-ttu-id="66ef0-233">Come generare e trasferire chiavi HSM protette le chiavi SSH per Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="66ef0-233">How to generate and transfer HSM-protected keys for Azure Key Vault</span></span>](/azure/key-vault/key-vault-hsm-protected-keys)
* [<span data-ttu-id="66ef0-234">Classe KeyVaultClient</span><span class="sxs-lookup"><span data-stu-id="66ef0-234">KeyVaultClient Class</span></span>](/dotnet/api/microsoft.azure.keyvault.keyvaultclient)
